using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Components;
using Bunit;
using NUnit.Framework;
using Misbah.BlazorDesktop.Components.Pages.Notes;
using Misbah.Core.Models;
using Misbah.Core.Services;
using Microsoft.Extensions.DependencyInjection;
using NSubstitute;

namespace Misbah.BlazorDesktop.Tests;

[TestFixture]
public class NoteListTests : Bunit.TestContext
{
    [Test]
    public void Renders_Notes_And_Selects_Note()
    {
        // Arrange
        var notes = new List<Note>
        {
            new Note { Id = "1", Title = "Note 1", Content = "A" },
            new Note { Id = "2", Title = "Note 2", Content = "B" }
        };
        var noteService = Substitute.For<INoteService>();
        noteService.GetAllNotes().Returns(notes);
        var folderService = Substitute.For<IFolderService>();
        folderService.LoadFolderTree(Arg.Any<string>()).Returns(new FolderNode { Name = "root", Path = "root" });
        Services.AddSingleton(noteService);
        Services.AddSingleton(folderService);
        Services.AddSingleton<NavigationManager>(new TestNavigationManager());

        // Act
        var cut = RenderComponent<NoteList>(parameters => parameters.Add(p => p.RootPath, "root"));

        // Assert
        Assert.That(cut.Markup, Does.Contain("Note 1"));
        Assert.That(cut.Markup, Does.Contain("Note 2"));
        // Simulate click
        cut.FindAll("li").First().Click();
        Assert.That(cut.FindAll("li", Does.Contain("selected")).First().GetAttribute("class"));
    }
}

// Minimal NavigationManager for test
public class TestNavigationManager : NavigationManager
{
    public TestNavigationManager() { Initialize("http://localhost/", "http://localhost/"); }
    protected override void NavigateToCore(string uri, bool forceLoad) { }
}
