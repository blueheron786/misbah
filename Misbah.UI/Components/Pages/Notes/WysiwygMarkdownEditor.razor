@using Misbah.Core.Models
@using Misbah.Core.Services
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject MarkdownRenderer MarkdownRenderer
@implements IAsyncDisposable

<div id="wysiwyg-editor-@editorId" class="wysiwyg-markdown-editor" style="height: @Height; overflow-y: auto;">
    <div class="editor-content" 
         contenteditable="true"
         @onblur="OnContentBlur"
         @oninput="OnContentInput"
         @onkeydown="OnKeyDown"
         @ref="editorElement">
        @((MarkupString)renderedContent)
    </div>
</div>
@if (_isSaved)
{
    <div class="wysiwyg-saved-indicator" style="color:#F80; font-size:0.95em; margin-top:6px; transition:opacity 0.5s;">Saved</div>
}

@code {
    [Parameter] public string Content { get; set; } = "";
    [Parameter] public EventCallback<string> ContentChanged { get; set; }
    [Parameter] public string Height { get; set; } = "600px";
    [Parameter] public string Theme { get; set; } = "dark";

    private string editorId = Guid.NewGuid().ToString("N")[..8];
    private string renderedContent = "";
    private string lastKnownContent = "";
    private ElementReference editorElement;
    private DotNetObjectReference<WysiwygMarkdownEditor>? dotNetRef;
    private bool _isSaved = false;
    private System.Timers.Timer? _saveTimer;

    protected override void OnInitialized()
    {
        dotNetRef = DotNetObjectReference.Create(this);
        UpdateRenderedContent();
    }

    protected override void OnParametersSet()
    {
        if (Content != lastKnownContent)
        {
            lastKnownContent = Content;
            UpdateRenderedContent();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("wysiwygMarkdownEditor.initialize", 
                $"wysiwyg-editor-{editorId}", dotNetRef);
        }
    }

    private void UpdateRenderedContent()
    {
        if (string.IsNullOrWhiteSpace(Content))
        {
            renderedContent = "<p class='placeholder'>Click here to start writing...</p>";
        }
        else
        {
            renderedContent = MarkdownRenderer.Render(Content, out var taskLines);
        }
    }

    private async Task OnContentInput(ChangeEventArgs e)
    {
        // Convert HTML back to markdown and notify parent
        await ConvertHtmlToMarkdownAndNotify();
    }

    private async Task OnContentBlur(FocusEventArgs e)
    {
        // Ensure content is saved when focus is lost
        await ConvertHtmlToMarkdownAndNotify();
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        // Handle special key combinations
        if (e.Key == "Enter" && (e.CtrlKey || e.MetaKey))
        {
            await ConvertHtmlToMarkdownAndNotify();
        }
    }

    private void ShowSavedIndicator()
    {
        _isSaved = true;
        StateHasChanged();
        _saveTimer?.Dispose();
        _saveTimer = new System.Timers.Timer(1200);
        _saveTimer.Elapsed += (s, e) => {
            _isSaved = false;
            InvokeAsync(StateHasChanged);
            _saveTimer?.Dispose();
        };
        _saveTimer.AutoReset = false;
        _saveTimer.Start();
    }

    private async Task ConvertHtmlToMarkdownAndNotify()
    {
        try
        {
            var html = await JSRuntime.InvokeAsync<string>("wysiwygMarkdownEditor.getContent", $"wysiwyg-editor-{editorId}");
            var markdown = await JSRuntime.InvokeAsync<string>("wysiwygMarkdownEditor.htmlToMarkdown", html);
            if (ContentChanged.HasDelegate && markdown != lastKnownContent)
            {
                lastKnownContent = markdown;
                await ContentChanged.InvokeAsync(markdown);
                ShowSavedIndicator();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error converting HTML to markdown: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnEditorContentChanged(string html)
    {
        try
        {
            var markdown = await JSRuntime.InvokeAsync<string>("wysiwygMarkdownEditor.htmlToMarkdown", html);
            if (ContentChanged.HasDelegate && markdown != lastKnownContent)
            {
                lastKnownContent = markdown;
                await ContentChanged.InvokeAsync(markdown);
                ShowSavedIndicator();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnEditorContentChanged: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (dotNetRef != null)
            {
                await JSRuntime.InvokeVoidAsync("wysiwygMarkdownEditor.dispose", $"wysiwyg-editor-{editorId}");
                dotNetRef.Dispose();
            }
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
