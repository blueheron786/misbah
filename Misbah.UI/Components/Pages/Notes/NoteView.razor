
<style>
.misbah-code {
    background: #23272e;
    color: #e6e6e6;
    font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', monospace;
    font-size: 0.98em;
    border-radius: 4px;
    padding: 0.2em 0.5em;
    margin: 0.1em 0;
    display: inline-block;
    white-space: pre;
}
pre.misbah-code {
    display: block;
    padding: 1em;
    overflow-x: auto;
}
</style>
@page "/notes/{NoteId}"
@using Misbah.Core.Models
@using Misbah.UI.Resources
@using Microsoft.JSInterop
@using Markdig
@inject Misbah.Core.Services.INoteService NoteService
@inject IJSRuntime JSRuntime

<style>
.misbah-code {
    background: #23272e;
    color: #e6e6e6;
    font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', monospace;
    font-size: 0.98em;
    border-radius: 4px;
    padding: 0.2em 0.5em;
    margin: 0.1em 0;
    display: inline-block;
    white-space: pre;
}
pre.misbah-code {
    display: block;
    padding: 1em;
    overflow-x: auto;
}
</style>

@code {

    private static NoteView? _instance;
    private static bool _jsHandlerRegistered = false;

    [Parameter] public string? NoteId { get; set; }
    private Note? note;
    private bool editMode = false;
    private string? editedContent;

    [JSInvokable("ToggleTask")]
    public static async Task ToggleTask(int line)
    {
        if (_instance != null && _instance.note != null && !string.IsNullOrEmpty(_instance.NoteId))
        {
            var lines = _instance.note.Content.Split('\n');
            if (line >= 0 && line < lines.Length)
            {
                var taskPattern = @"^- \[( |x)\] (.*)$";
                var match = System.Text.RegularExpressions.Regex.Match(lines[line], taskPattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                if (match.Success)
                {
                    bool isChecked = match.Groups[1].Value.ToLower() == "x";
                    string newLine = isChecked ? "- [ ] " + match.Groups[2].Value : "- [x] " + match.Groups[2].Value;
                    lines[line] = newLine;
                    _instance.note.Content = string.Join("\n", lines);
                    _instance.NoteService.SaveNote(_instance.note);
                    // Reload the note from storage to ensure latest content
                    _instance.note = _instance.NoteService.LoadNote(_instance.NoteId);
                    _instance.editedContent = _instance.note.Content;
                    await _instance.InvokeAsync(_instance.StateHasChanged);
                }
            }
        }
    }
    
    protected override void OnParametersSet()
    {
        _instance = this;
        if (!string.IsNullOrEmpty(NoteId))
        {
            note = NoteService.LoadNote(NoteId);
            editedContent = note?.Content;
            editMode = false;
        }
    }

    void ToggleEdit()
    {
        editMode = !editMode;
        if (editMode && note != null)
            editedContent = note.Content;
    }

    void Save()
    {
        if (note != null && editedContent != null)
        {
            note.Content = editedContent;
            NoteService.SaveNote(note);
            editMode = false;
        }
    }

    // Main markdown renderer
    MarkupString RenderMarkdownWithLinks(string? content)
    {
        if (!_jsHandlerRegistered)
        {
            _jsHandlerRegistered = true;
            _ = JSRuntime.InvokeVoidAsync("eval", @"
                window.addEventListener('misbah-task-toggle', function(e) {
                    if (e.detail && typeof DotNet !== 'undefined') {
                        DotNet.invokeMethodAsync('Misbah.UI', 'ToggleTask', e.detail.line);
                    }
                });
            ");
        }

        var html = RenderMarkdownHtml(content);
        html = AddExternalLinkEmoji(html);
        html = ReplaceWikiLinks(html);
        return (MarkupString)html;
    }

    // Helper: Render markdown to HTML, handling code blocks, tasks, and inline code
    private string RenderMarkdownHtml(string? content)
    {
        string[] lines = (content ?? "").Split('\n');
        var htmlLines = new List<string>();
        bool inList = false;
        bool inCodeBlock = false;
        int emptyCount = 0;
        // Use Markdig pipeline with advanced extensions for highlight support
        var pipeline = new Markdig.MarkdownPipelineBuilder().UseAdvancedExtensions().Build();
        for (int i = 0; i < lines.Length; i++)
        {
            // Code block start/end
            if (lines[i].TrimStart().StartsWith("```") )
            {
                if (!inCodeBlock) {
                    htmlLines.Add("<pre class='misbah-code'><code class='misbah-code'>");
                    inCodeBlock = true;
                } else {
                    htmlLines.Add("</code></pre>");
                    inCodeBlock = false;
                }
                emptyCount = 0;
                continue;
            }
            if (inCodeBlock)
            {
                htmlLines.Add(System.Net.WebUtility.HtmlEncode(lines[i]) + "\n");
                continue;
            }
            // Task list
            var match = System.Text.RegularExpressions.Regex.Match(lines[i], @"^- \[( |x)\] (.*)$", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
            if (match.Success)
            {
                if (!inList) { htmlLines.Add("<ul>"); inList = true; }
                bool isChecked = match.Groups[1].Value.ToLower() == "x";
                string taskText = match.Groups[2].Value;
                string checkbox = $"<input type='checkbox' class='md-task' data-line='{i}' {(isChecked ? "checked" : "")} onclick=\"window.dispatchEvent(new CustomEvent('misbah-task-toggle',{{detail:{{line:{i}}}}}));\">";
                htmlLines.Add($"<li>{checkbox} {System.Net.WebUtility.HtmlEncode(taskText)}</li>");
                emptyCount = 0;
            }
            else
            {
                if (inList) { htmlLines.Add("</ul>"); inList = false; }
                // Collapse multiple empty lines to a single <br>
                if (string.IsNullOrWhiteSpace(lines[i]))
                {
                    emptyCount++;
                    if (emptyCount == 1) htmlLines.Add("<br>");
                    continue;
                }
                emptyCount = 0;
                // Inline code: `code`
                var inlineCode = System.Text.RegularExpressions.Regex.Replace(
                    lines[i],
                    "`([^`]+)`",
                    m => $"<code class='misbah-code'>{System.Net.WebUtility.HtmlEncode(m.Groups[1].Value)}</code>");
                // Render non-task, non-code lines with Markdig (for formatting, links, etc.)
                var lineHtml = Markdig.Markdown.ToHtml(inlineCode, pipeline);
                if (lineHtml.StartsWith("<p>") && lineHtml.EndsWith("</p>\n"))
                    lineHtml = lineHtml.Substring(3, lineHtml.Length - 8);
                htmlLines.Add(lineHtml);
            }
        }
        if (inList) { htmlLines.Add("</ul>"); }
        return string.Join("", htmlLines);
    }

    // Helper: Add globe emoji to external links
    private string AddExternalLinkEmoji(string html)
    {
        return System.Text.RegularExpressions.Regex.Replace(
            html,
            @"<a ([^>]*href=""https?://[^""]+""[^>]*)>(.*?)</a>",
            m => $"<a {m.Groups[1].Value}>{m.Groups[2].Value}</a> ðŸŒ",
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }

    // Helper: Replace [[Page Name]] with internal anchor tags
    private string ReplaceWikiLinks(string html)
    {
        return System.Text.RegularExpressions.Regex.Replace(
            html,
            @"\[\[([^\]]+)\]\]",
            new System.Text.RegularExpressions.MatchEvaluator(m =>
            {
                var page = m.Groups[1].Value.Replace("\"", "&quot;");
                var linkHtml = "<a href=\"#\" onclick=\"window.dispatchEvent(new CustomEvent('misbah-nav', { detail: { title: '" + page + "' } }));return false;\">" + page + "</a>";
                return linkHtml;
            }),
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }
}

@if (note != null)
{
    <div class="note-view">
        <h2>@note.Title</h2>
        <button @onclick="ToggleEdit">@(editMode ? AppStrings.Cancel : AppStrings.Edit)</button>
        @if (editMode)
        {
            <textarea @bind="editedContent" rows="20" style="width:100%"></textarea>
            <button @onclick="Save">@AppStrings.Save</button>
        }
        else
        {
            <div style="display:flex;align-items:center;gap:1em;">
                <div class="markdown-body" style="flex:1;">@RenderMarkdownWithLinks(note.Content)</div>
                <button class="btn btn-secondary" @onclick="ShowHtmlModal">View Rendered HTML</button>
            </div>
            @if (showHtmlModal)
            {
                <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:9999;display:flex;align-items:center;justify-content:center;">
                    <div style="background:#fff;padding:1.5em;max-width:90vw;max-height:90vh;overflow:auto;border-radius:8px;box-shadow:0 2px 16px #0004;">
                        <button class="btn btn-danger" style="float:right;" @onclick="CloseHtmlModal">Close</button>
                        <button class="btn btn-primary" style="float:right;margin-right:0.5em;" @onclick="CopyRenderedHtml">Copy HTML</button>
                        <pre style="font-size:12px;white-space:pre-wrap;word-break:break-all;max-width:80vw;max-height:70vh;overflow:auto;">@renderedHtml</pre>
                    </div>
                </div>
            }
        }
@code {
    private bool showHtmlModal = false;
    private string? renderedHtml;

    private void ShowHtmlModal()
    {
        renderedHtml = RenderMarkdownHtml(note?.Content);
        showHtmlModal = true;
    }

    private void CloseHtmlModal() => showHtmlModal = false;

    private async Task CopyRenderedHtml()
    {
        if (!string.IsNullOrEmpty(renderedHtml))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", renderedHtml);
        }
    }
}
    </div>
}
else
{
    <p>@AppStrings.SelectNoteToViewOrEdit</p>
}
